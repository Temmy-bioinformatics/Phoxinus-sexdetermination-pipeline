import os
import sys

# ─────────────────────────────────────────────────────────────
# Load configuration
# ─────────────────────────────────────────────────────────────
configfile: "/home/toriowo/Snakemake_projects/sexfindr-snakemake/snp-based-analyses/config/config.yaml"

species_list = config.get("SPECIES", [])
if isinstance(species_list, str):
    species_list = [species_list]

genders = ["Male", "Female"]
sample_dir = config["SAMPLE_DIR"]
vcf_lists = config["VCF_LISTS"]
output_dir = config["OUTPUT_DIR"]

# Flags to toggle modules
run_fst = config.get("RUN_FST", False)
run_nuc_div = config.get("RUN_NUC_DIV", False)
run_extract_bcf = config.get("RUN_EXTRACT_BCF", False)
run_snp_density = config.get("RUN_SNP_DENSITY", False)
run_snp_gwas = config.get("RUN_SNP_GWAS", False)
run_plotting = config.get("RUN_PLOTTING", False)

# Print active modules
print("Running modules:", file=sys.stderr)
print(
    f"FST: {run_fst}, NucDiv: {run_nuc_div}, Extract BCF: {run_extract_bcf}, "
    f"SNP Density: {run_snp_density}, SNP GWAS: {run_snp_gwas}, Plotting: {run_plotting}",
    file=sys.stderr
)

# ─────────────────────────────────────────────────────────────
# Include rule files conditionally
# ─────────────────────────────────────────────────────────────
if run_fst:
    include: "workflow/rules/01-fst.smk"
if run_nuc_div:
    include: "workflow/rules/02-pi.smk"
if run_extract_bcf:
    include: "workflow/rules/03-extract-sample-bcf.smk"
if run_snp_density:
    include: "workflow/rules/04-run-snp-density.smk"
if run_snp_gwas:
    include: "workflow/rules/05-snp-gwas.smk"
if run_plotting:
    include: "workflow/rules/06-plot-results.smk"

# ─────────────────────────────────────────────────────────────
# Helper: Parse VCF sample lists
# ─────────────────────────────────────────────────────────────
def get_samples(vcf_lists, gender):
    samples = {}
    for vcf_list in vcf_lists:
        sp, ext = vcf_list.rsplit("_", 1)
        vcf_gender = ext.split(".")[0]
        if vcf_gender == gender:
            with open(os.path.join(sample_dir, vcf_list)) as fh:
                samples[sp] = fh.read().splitlines()
    return samples

male_samples_dict = get_samples(vcf_lists, "Male")
female_samples_dict = get_samples(vcf_lists, "Female")

samples_dict = {
    sp: {
        "Male": male_samples_dict.get(sp, []),
        "Female": female_samples_dict.get(sp, [])
    }
    for sp in set(f.split("_")[0] for f in vcf_lists)
}

# ─────────────────────────────────────────────────────────────
# Define final output targets
# ─────────────────────────────────────────────────────────────
final_outputs = []

if run_fst:
    final_outputs += expand(
        os.path.join(output_dir, "fst", "{species}", "{species}_Fst_10k.windowed.weir.fst"),
        species=species_list
    )
    final_outputs += expand(
        os.path.join(output_dir, "fst", "{species}", "{species}_Fst.txt.weir.fst"),
        species=species_list
    )

if run_nuc_div:
    final_outputs += expand(
        os.path.join(output_dir, "pi", "{species}", "{species}_{gender}_10k_nucleotide_diversity.windowed.pi"),
        species=species_list,
        gender=genders
    )

if run_extract_bcf:
    indv_bcf_dir = config["INDV_BCF_DIR"]
    for gender, sample_dict in [("Male", male_samples_dict), ("Female", female_samples_dict)]:
        for species in species_list:
            if species in sample_dict:
                final_outputs += expand(
                    os.path.join(indv_bcf_dir, "{species}", gender, "{sample}.bcf"),
                    species=[species],
                    sample=sample_dict[species]
                )

if run_snp_density:
    snp_density_dir = os.path.join(output_dir, "snpdensity")
    for species in species_list:
        final_outputs += [
            os.path.join(snp_density_dir, species, f"{gender}_{sample}_10k.snpden")
            for gender in genders
            for sample in samples_dict[species][gender]
        ]

if run_snp_gwas:
    pheno_output_dir = os.path.join(output_dir, "snp_gwas", "pheno_files")
    bed_output_dir = os.path.join(output_dir, "snp_gwas", "bed_files")
    gwas_output_dir = os.path.join(output_dir, "snp_gwas", "gwas")

    final_outputs += expand(
        os.path.join(pheno_output_dir, "{species}", "{species}.pheno.txt"),
        species=species_list
    )
    final_outputs += expand(
        os.path.join(bed_output_dir, "{species}", "{species}.{ext}"),
        species=species_list,
        ext=["bed", "bim", "fam"]
    )
    final_outputs += expand(
        os.path.join(gwas_output_dir, "{species}", "output", "{species}_gemma.log"),
        species=species_list
    )

if run_plotting:
    final_outputs += expand(
        [
            os.path.join(output_dir, "plotting", "{species}", "{species}_Fst_10k_plot.tiff"),
            os.path.join(output_dir, "plotting", "{species}", "{species}_Fst_10k_thresholds.txt"),
            os.path.join(output_dir, "plotting", "{species}", "{species}_NucDiv_10kb_sex_differences_plot.tiff"),
            os.path.join(output_dir, "plotting", "{species}", "{species}_SNPdensity_plot.pdf"),
            os.path.join(output_dir, "plotting", "{species}", "{species}_significant_SNPdensity_SexFindR.txt"),
            os.path.join(output_dir, "plotting", "{species}", "{species}_GWAS.tiff"),
            os.path.join(output_dir, "plotting", "{species}", "{species}_GWAS_out_sort_cut.txt"),
        ],
        species=species_list
    )

# ─────────────────────────────────────────────────────────────
# Rule: all
# ─────────────────────────────────────────────────────────────
rule all:
    input:
        final_outputs
